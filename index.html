<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Photo Uploader</title>
  <style>
    body { font-family: Arial; text-align: center; }
    .gallery { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .gallery img { width: 150px; height: auto; cursor: pointer; border-radius: 8px; }
    #lightbox {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center;
      flex-direction: column; z-index: 1000;
    }
    #lightbox img { max-width: 80vw; max-height: 80vh; margin-bottom: 20px; border-radius: 8px; }
    #lightbox button { padding: 10px 20px; margin: 5px; }
    #closeBtn { position: absolute; top: 10px; right: 20px; font-size: 24px; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Upload Your Wedding Photos</h1>
  <input type="file" id="fileInput" multiple accept="image/*" />
  <div id="status"></div>
  <div class="gallery" id="gallery"></div>

  <!-- Lightbox Modal -->
  <div id="lightbox">
    <div id="closeBtn" onclick="closeLightbox()">âœ–</div>
    <img id="lightboxImage" src="">
    <a id="downloadLink" href="#" download>
      <button>Download Full Image</button>
    </a>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <!-- Pica for resizing -->
  <script src="https://unpkg.com/pica@8.0.0/dist/pica.min.js"></script>

  <script>
    // Firebase config (replace with your own project config)
    const firebaseConfig = {
      apiKey: "AIzaSyCCCwPOV2Dh0zZnEWzIdHzAxOJP1kKR6sU",
      authDomain: "svadbafoto-22df5.firebaseapp.com",
      projectId: "svadbafoto-22df5",
      storageBucket: "svadbafoto-22df5.firebasestorage.app",
      messagingSenderId: "466308248816",
      appId: "1:466308248816:web:edf8f6920013d3fd227e35",
    };

    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    const fileInput = document.getElementById('fileInput');
    const gallery = document.getElementById('gallery');
    const statusDiv = document.getElementById('status');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const downloadLink = document.getElementById('downloadLink');

    fileInput.addEventListener('change', async (e) => {
      const files = e.target.files;
      statusDiv.innerText = `Uploading ${files.length} file(s)...`;
      for (const file of files) {
        try {
          const fullRef = storage.ref(`uploads/${file.name}`);
          await fullRef.put(file);
          console.log(`Uploaded full image: ${file.name}`);

          const thumbBlob = await createThumbnail(file);
          const thumbRef = storage.ref(`uploads/${file.name.replace(/\.(\w+)$/, '_thumb.jpg')}`);
          await thumbRef.put(thumbBlob);
          console.log(`Uploaded thumbnail: ${file.name}`);
        } catch (err) {
          console.error(`Failed to upload ${file.name}`, err);
        }
      }
      statusDiv.innerText = 'Upload complete.';
      loadGallery();
    });

    async function createThumbnail(file) {
      const img = new Image();
      const bitmap = await createImageBitmap(file);
      const canvas = document.createElement('canvas');
      const scale = 150 / bitmap.width;
      canvas.width = 150;
      canvas.height = bitmap.height * scale;
      await pica().resize(bitmap, canvas);
      return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.7));
    }

    async function loadGallery() {
      gallery.innerHTML = '';
      const listRef = storage.ref('uploads');
      const result = await listRef.listAll();

      const thumbnails = result.items.filter(item => item.name.includes('_thumb'));

      for (const thumbRef of thumbnails) {
        const thumbURL = await thumbRef.getDownloadURL();
        const fullImageName = thumbRef.name.replace('_thumb.jpg', '');
        const fullRef = storage.ref(`uploads/${fullImageName}`);
        const fullURL = await fullRef.getDownloadURL();

        const img = document.createElement('img');
        img.src = thumbURL;
        img.alt = fullImageName;
        img.onclick = () => openLightbox(thumbURL, fullURL);
        gallery.appendChild(img);
      }
    }

    function openLightbox(thumbUrl, fullUrl) {
      lightboxImage.src = thumbUrl;
      downloadLink.href = fullUrl;
      lightbox.style.display = 'flex';
    }

    function closeLightbox() {
      lightbox.style.display = 'none';
    }

    loadGallery();
  </script>
</body>
</html>
